# Apache Kafka Application Programing

- 개요 : 인프런 강의

## 1. 아파치 카프카의 역사와 미래

- 탄생배경 : 링크드인에서 파편화된 데이터 수집 및 분배 아키텍쳐 운영에 어려움이 있었음
  - 아키텍쳐가 거대해지고, 소스 app과 타겟 app의 갯수가 늘어나면서 전송라인이 기하급수적으로 복잡해짐
  - 카프카는 각각의 App을 연결하여 data를 처리하는것이 아니라 한 곳에 모아(Unified Log) 처리할 수 있도록 중앙집중화 함
- 구조 : 케시지 큐와 동일한 FIFO 구조
  - 파편화된 데이터파이프라인의 복잡도를 낮출수 있음
  - 소스 애플리케이션과 타깃 애플리케이션 간의 커플링을 제거
  - 한쪽의 이슈가 다른 app에 영향을 미치는 의존도를 타파
    - 데이터를 어느 app에 넣을지 고민하는 것이 아니라 카프카로 넣으면 된다
  - 프로듀서(데이터를 큐에 보냄)과 컨슈머(데이터를 큐에서 가져감)로 구선
- 특징
  - 높은 처리량
    - 많은 양의 데이터를 묶음단위로 처리하는 배치로 빠르게 처리하고 네트워크 통신을 최소한으로 함
    - 파티션 단위를 통해 동일 목적 데이터를 여러 파티션에 분배하고 데이터를 병렬 처리
      - 파티션 개수 만큼 컨슈머 개수를 늘려 동일 시간당 데이터 처리량 증가
  - 확장성
    - 카프카 클러스터의 브로커를 통해 자연스러운 스케일 아웃과 스케일 인을 지원 (무중단)
  - 영속성 : 프로그램을 종료해도 데이터가 사라지지 않음
    - 카프카는 다른 메시징 플랫폼과 다르게 전송 데이터를 메모리가 아닌 파일 시스템에 저장
      - 파일 시스템이면 느려보이지만 운영체제 레벨에서 페이지 캐시(Cache) 영역을 만들고 재접근을 빠르게 하는 방식등을 활용하여 속도를 보장
    - 파일 시스템 덕에 브로커 애플리케이션이 장애가 발생해 종료되도 프로세스 재시작으로 안전한 처리가 가능
  - 고가용성
    - 카프카 클러스터는 3개 이상의 서버로 운영
    - 복제 옵션 : 프로듀서로 받은 데이터를 여러 브로커 중 1대만이 아닌 여러 브로커에 저장
      - 옵션에 따라 리전 단위의 장애에도 데이터를 안전하게 복제할 수 있음
- 역사
  - 초기 : 엔드 투 엔드로 데이터를 배치로 모음
    - 원천 데이터로부터 파생된 데이터의 히스토리 파악하기 힘듬
    - 계속된 데이터 가공으로 인한 데이터 파편화 > 데이터 거버넌스(데이터 표준 및 정책) 준수가 난해
  - 람다 아키텍쳐 : 3가지 레이어로 구성 (구조 : 원천 > 배치-느림,일괄, 스피드-빠름 > 서빙)
    - 배치 레이어 : 배치 데이터를 모아 특정 시간, 타이밍마다 일괄 처리
    - 서빙 레이어 : 가공된 데이터를 데이터 사용자와 서비스 app이 사용할 수 있도록 저장
    - 스피드 레이어 : 서비스로부터 생성된 원천 데이터를 실시간으로 분석
      - 카프카가 여기에 위치
    - 단점 : 로직 파편화, 디버깅, 배포, 운영 분리 이슈 발생
      - 원천 데이터를 처리하는 곳이 두 개이기 때문에, 로직이 2배로 필요하거나 융합할때 다소 유연하지 못함
        - 1개의 로직을 추상화하고 각각의 레이어에 적용하는 서밍버드가 있었지만 완전해결은 아니었음
  - 카파 아키텍쳐 : 람다 아키텍쳐에서 배치레이어를 제거하고 스피드 레이어에서 모든 데이터를 처리
    - 활용 : 배치데이터 표현시, 시간, 일자 등 전체 데이터가 백업된 스냅샷 데이터가 아닌 시간 순서대로 기록한 변환 기록 로그(change log)를 활용함으로서 스냅샷 데이터 저장 없이 배치데이터 표현이 가능
    - 구분
      - 배치 데이터(ex-하둡)
        - 한정적 데이터 처리
        - 대규모 배치 데이터를 위한 분산처리 수행
        - 분, 시간, 일 단위 처리를 위한 지연 발생
        - 복잡한 키 조인 수행
      - 스트림 데이터
        - 무한 데이터 처리
        - 지속적으로 들어오는 데이터를 위한 분산 처리 수행
        - 분 단위 이하 지연 발생
        - 단순한 키 조인 수행
        - 로그에 시간을 남기는 것으로 스트림 적재 데이터도 배치로 처리할 수 있음
  - 스트리밍 데이터 레이크 : 카파 아키텍쳐에서 서빙 레이어를 제거. 스피드 레이어만 남음
    - 스피드 레이어에 대규모 데이터를 저장(롱 텀 저장소)하고 사용할 수 있게 해서 이중으로 관리되는 운영 리소스를 감소
    - 자주 접근하는 데이터와 그렇지 않은 데이터를 구분해서 후자를 오브젝트 스토리지 같은 저렴한 저장소에 저장하고 자주 쓰는 데이터만 브로커에서 사용하는 작업이 필요
